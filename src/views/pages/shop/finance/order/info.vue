<template>
  <section :class="basic()">
    <st-panel title="订单详情">
      <div slot="actions">
        <st-button
          class="mg-r8"
          v-if="auth['brand_shop:order:order|refund']"
          @click="onRefund"
          type="primary"
        >
          退款
        </st-button>
        <st-button
          class="mg-r8"
          v-if="auth['brand_shop:order:order|pay']"
          @click="createdOrderPay"
          type="primary"
        >
          收款
        </st-button>
        <st-button
          class="mg-r8"
          v-if="auth['brand_shop:order:order|cancel']"
          @click="onCancel"
          type="primary"
        >
          取消
        </st-button>
        <st-button
          class="mg-r8"
          v-if="auth['brand_shop:order:order|split']"
          @click="onSplit"
          type="primary"
        >
          业绩拆分
        </st-button>
      </div>
      <a-row :gutter="24">
        <a-col :span="9">
          <st-info>
            <st-info-item label="订单号">{{ info.id }}</st-info-item>
            <st-info-item label="商品名称">
              {{ info.product_name }}
            </st-info-item>
            <st-info-item label="购买会员">
              {{ info.member_name }} {{ info.member_mobile }}
            </st-info-item>
            <st-info-item label="下单人">{{ info.operator_name }}</st-info-item>
            <st-info-item label="下单时间">
              {{ info.created_time }}
            </st-info-item>
            <st-info-item label="销售">{{ info.staff_name }}</st-info-item>
            <st-info-item label="订单状态">
              {{ info.order_status | enumFilter('finance.order_status') }}
            </st-info-item>
          </st-info>
        </a-col>
        <a-col :span="9">
          <st-info>
            <st-info-item label="赠送">{{ info.gift_amount }}</st-info-item>
            <st-info-item label="订单总额">{{ info.total_price }}</st-info-item>
            <st-info-item label="优惠金额">
              {{ info.order_discount }}
            </st-info-item>
            <st-info-item label="减免金额">
              {{ info.reduce_price }}
            </st-info-item>
            <st-info-item label="应收金额">{{ info.pay_price }}</st-info-item>
            <st-info-item label="支付状态">
              {{ info.pay_status | enumFilter('finance.pay_status') }}
            </st-info-item>
          </st-info>
        </a-col>
        <a-col :span="6">
          <st-info>
            <st-info-item label="备注">{{ info.description }}</st-info-item>
          </st-info>
        </a-col>
      </a-row>
    </st-panel>
    <st-panel
      initial
      class="mg-t12"
      :class="basic('panel-bottom')"
      :tabs="tabs"
    >
      <router-view></router-view>
    </st-panel>
  </section>
</template>
<script>
import { InfoService } from './info.service'
import ShopFinanceCancel from '@/views/biz-modals/shop/finance/cancel'
import ShopFinanceRefund from '@/views/biz-modals/shop/finance/refund'
import ShopFinanceSplit from '@/views/biz-modals/shop/finance/split'
import SoldDealGathering from '@/views/biz-modals/sold/deal/gathering'
import { ORDER_PRODUCT_TYPE } from '@/constants/finance/order'
export default {
  name: 'PageShopFinanceOrderInfo',
  bem: {
    basic: 'page-shop-finance-info'
  },
  modals: {
    ShopFinanceCancel,
    ShopFinanceRefund,
    ShopFinanceSplit,
    SoldDealGathering
  },
  serviceInject() {
    return {
      infoService: InfoService
    }
  },
  rxState() {
    return {
      info: this.infoService.info$,
      tabs: this.infoService.tabs$,
      auth: this.infoService.auth$
    }
  },
  data() {
    return {
      ORDER_PRODUCT_TYPE
    }
  },
  computed: {},
  methods: {
    // 订单收款modal
    createdOrderPay() {
      this.$modalRouter.push({
        name: 'sold-deal-gathering',
        props: {
          order_id: this.infoService.id,
          type: this.productType(this.info.product_type)
        },
        on: {
          success: () => {
            this.$router.reload()
          }
        }
      })
    },
    // 退款
    onRefund() {
      const props = { id: this.infoService.id }
      if (this.info.product_type === this.ORDER_PRODUCT_TYPE.EARNEST) {
        props.goodsInvalid = true
      }
      this.$modalRouter.push({
        name: 'shop-finance-refund',
        props,
        on: {
          success: () => {
            this.$router.reload()
          }
        }
      })
    },
    // 业务拆分
    onSplit() {
      this.$modalRouter.push({
        name: 'shop-finance-split',
        props: {
          id: this.info.id
        },
        on: {
          success: result => {
            this.$router.reload()
          }
        }
      })
    },
    // 取消
    onCancel() {
      this.$modalRouter.push({
        name: 'shop-finance-cancel',
        props: {
          id: this.info.id
        },
        on: {
          success: result => {
            console.log('取消订单!')
            this.$router.reload()
          }
        }
      })
    },
    productType(type) {
      let name = ''
      // 1-会员卡 2-私教课 3-团体课 4-课程包 5-储值卡 6-小班课 7-手续费 8-定金 9-押金 10-储物柜
      switch (type) {
        case 1:
          name = 'member'
          break
        case 2:
          name = 'personal'
          break
        case 3:
          name = 'member'
          break
        case 4:
          name = 'package'
          break
        case 5:
          name = 'deposit'
          break
        case 6:
          name = 'member'
          break
        case 7:
          name = 'advance'
          break
        case 8:
          name = 'advance'
          break
        case 9:
          name = 'member'
          break
        case 10:
          name = 'cabinet_order'
          break
      }
      return name
    }
  }
}
</script>
